<html>
<head>
	<title>gleeBox Options</title>
	<style>
	body{
		background-color:#dedede;
		color:#333;
		font-family:Verdana,Helvetica, serif;
		font-size:13px;
	}
	h2{
		text-align:center;
		color:#333;
		margin:30px 0px;
		font-size:40px;
		font-weight:normal;
		font-family:Garamond,"Times New Roman",serif;
	}
	ul{
		list-style-type:none;
		margin:0;
		padding:0;
	}
	#options{
		margin-left:20px;
		float:left;
	}
	.option-label{
		float:left;
		width:200px;
	}
	.option-field{
		float:left;
		margin-left: 20px;
	}
	ul li{
		margin-bottom:30px;
		display:block;
		float:left;
		clear:both;
	}
	ul li li{
		border:none;
		float:none;
		margin:0;
		margin-bottom:12px;
	}
	ul li ul{
		margin:0;
		padding:0;
	}
	input{
		border:0;
		background-color:#ccc;
		border:2px solid #aaa;
		font-size:13px;
		padding:2px 3px;
		color:#333;
	}
	input:focus{
		outline:none;
	}
	.button:hover{
		cursor:pointer;
		background-color:#777;
		color:#fff;
	}
	.button:active{
		background-color:#444;
	}
	.inline_button{
		padding-left:20px;
		float:right;
	}
	#addDomainLi{
		margin-top:10px;
	}
	#status{
		height:20px;
		padding:2px;
		text-align:center;
		margin:30px auto;
	}
	.subtext{
		font-size:11px;
	}
	</style>
<script type="text/javascript">

// Saves options to localStorage
function save_options() {

	//saving the disabled URLs
	var restrictedDomains = [];
	var domainList = document.getElementById("domains");
	for(var i=0;i<domainList.children.length;i++)
	{
		if(domainList.children[i].className == "rdomain")
			restrictedDomains[restrictedDomains.length] = domainList.children[i].innerText;
	}
	//currently using , as the end marker. need a better way to implement this
	localStorage["glee_domains"] = restrictedDomains;

	//saving the gleeBox position
	if(document.getElementsByName("glee_pos")[0].checked) //top
		pos = 0;
	else if(document.getElementsByName("glee_pos")[1].checked) //middle
		pos = 1;
	else 	//bottom
		pos = 2;
	localStorage["glee_position"] = pos;
	
	//saving the gleeBox size
	if(document.getElementsByName("glee_size")[0].checked) //small
		size = 0;
	else if(document.getElementsByName("glee_size")[1].checked) //medium
		size = 1;
	else 	//large
		size = 2;
	localStorage["glee_size"] = size;
	
	//saving bookmarks search option
	if(document.getElementsByName("glee_bookmark_search")[0].checked)
		bookmark_search = 1; //1 indicates enabled
	else
		bookmark_search = 0;
	
	localStorage["glee_bookmark_search"] = bookmark_search;
	
	//saving scrolling animation pref
	if(document.getElementsByName("glee_scrolling_animation")[0].checked)
		animation = 1; //enabled
	else
		animation = 0;
	
	localStorage["glee_scrolling_animation"] = animation;

	propagateChanges(pos,size,bookmark_search,animation,restrictedDomains);
	setStatus("Settings saved!");
}

function propagateChanges(pos,size,bookmark_search,animation,domains){
	//get all the windows and their tabs to propagate the change in status
	chrome.windows.getAll({populate:true}, function(windows){
		for( i=0; i<windows.length; i++)
		{
			//set the status in all the tabs open in the window
			for(j=0;j<windows[i].tabs.length;j++)
			{
				chrome.tabs.sendRequest(windows[i].tabs[j].id, {value:"updateOptions",position:pos,size:size,bookmark_search:bookmark_search,animation:animation,domains:domains},function(response){
				});
			}
		}
	});
}
// Restores select box state to saved value from localStorage.
function restore_options() 
{
	//getting the user defined restricted domains
	var domainBuffer = localStorage["glee_domains"];
	if(typeof(domainBuffer) == "undefined")
	{
		//initialize with the default domains that should be blocked
		domainBuffer = "mail.google.com,google.com/reader,wave.google.com";
		localStorage["glee_domains"] = domainBuffer;
	}
	if(domainBuffer.length != 0)
	{
		//parsing domainBuffer to get the domains
		var restrictedDomains = domainBuffer.split(",");
		var domainList = document.getElementById("domains");
		//TODO: use lastChild property here
		var lastChild = document.getElementById("addDomainLI");
		//displaying the domains in the restricted list
		for (var i=0; i<restrictedDomains.length; i++)
		{
			var newLI = document.createElement('li');
			var inputBt = "<input class='button' style='float:right' type='button' value='Remove' onclick='removeDomain("+i+")'/>";
			newLI.className = "rdomain";
			newLI.id = "rdomain"+i;
			newLI.innerHTML = restrictedDomains[i] + inputBt;
			domainList.insertBefore(newLI,lastChild);
		}
	}
	//getting the gleeBox position
	var pos = localStorage["glee_position"];
	if(pos)
		document.getElementsByName("glee_pos")[pos].checked = true;
	else
		document.getElementsByName("glee_pos")[1].checked = true; //default is middle position
		
	//getting the gleeBox size
	var size = localStorage["glee_size"];
	if(size)
		document.getElementsByName("glee_size")[size].checked = true;
	else
		document.getElementsByName("glee_size")[2].checked = true; //default is large size
		
	//getting the bookmark search status (enabled/disabled)
	var bookmark_status = localStorage["glee_bookmark_search"];
	if(bookmark_status != null)
	{
		if(bookmark_status == 1)
			document.getElementsByName("glee_bookmark_search")[0].checked = true;
		else
			document.getElementsByName("glee_bookmark_search")[1].checked = true;
	}
	else
		document.getElementsByName("glee_bookmark_search")[1].checked = true;
		
	//getting the scrolling animation pref
	var scroll_anim = localStorage["glee_scrolling_animation"];
	if(scroll_anim != null)
	{
		if(scroll_anim == 1)
			document.getElementsByName("glee_scrolling_animation")[0].checked = true;
		else
			document.getElementsByName("glee_scrolling_animation")[1].checked = true;
	}
	else
		document.getElementsByName("glee_scrolling_animation")[0].checked = true;
}

//Adds a domain to the restricted domain list
function addDomain() {
	var newDomain = document.getElementById("add_domain");
	var lastChild = document.getElementById("addDomainLI");
	//TODO: create a validate() method with more strict validation
	if(newDomain.value != "")
	{
		var domainList = document.getElementById("domains");
		var newLI = document.createElement('li');
		var no = domainList.children.length+1;
		var inputBt = "<input class='button' style='float:right' type='button' value='Remove' onclick='removeDomain("+no+")'/>";
		newLI.className = "rdomain";
		newLI.id = "rdomain"+no;
		newLI.innerHTML = newDomain.value + inputBt;
		domainList.insertBefore(newLI,lastChild);
		newDomain.value = "";
		setStatus("URL Added!");
		return 0;
	}
	return 1;
}

function removeDomain(i){
	var el = document.getElementById("rdomain"+i);
	var domainList = document.getElementById("domains");
	domainList.removeChild(el);
	//remove the domain from the list
	setStatus("URL Removed!");
	return 0;
}

function setStatus(text){
	document.getElementById("status").innerHTML = text;
}

</script>
</head>
<body onload="restore_options()">
<h2>gleeBox Options</h2>
<div id="status"></div>
<!--Specifying different options available -->
<div id="options">
	<ul id="options">
		<li>
			<label class="option-label">Disabled URLs:<br/><span class="subtext">gleeBox will be disabled for these</span></label>
			<ul id="domains" class="option-field">
				<li id="addDomainLI"><input id="add_domain" type="text" value="" size=50 /><input type="button" value="Add" class="button" onclick="addDomain()"/></li>
			</ul>
		</li>
		<li>
			<label class="option-label">gleeBox Position:<br/><span class="subtext">Where do you want gleeBox to be displayed on your screen?</span></label>
			<div class="option-field">
				<input name="glee_pos" type="radio"> Top
				<input name="glee_pos" type="radio"> Middle
				<input name="glee_pos" type="radio"> Bottom
			</div>
		</li>
		<li>
			<label class="option-label">gleeBox Size:<br/><span class="subtext">How big do you want gleeBox to be?</span></label>
			<div class="option-field">
				<input name="glee_size" type="radio"> Small
				<input name="glee_size" type="radio"> Medium
				<input name="glee_size" type="radio"> Large
			</div>
		</li>
		<li>
			<label class="option-label">Bookmark search:<br/><span class="subtext">Should gleeBox search bookmarks when no links are found on a page for a query?</span></label>
			<div class="option-field">
				<input name="glee_bookmark_search" type="radio"> Enabled
				<input name="glee_bookmark_search" type="radio"> Disabled
			</div>
		</li>
		<li>
			<label class="option-label">Animated scrolling:<br/><span class="subtext">Do you want the scroll animation when traversing selected elements using gleeBox?</span></label>
			<div class="option-field">
				<input name="glee_scrolling_animation" type="radio"> Yes
				<input name="glee_scrolling_animation" type="radio"> No
			</div>
		</li>
	</ul>
<input type="button" style="float:right;clear:both;" class="button" value="Save" onclick="save_options()">
</div>	
</body>
</html>