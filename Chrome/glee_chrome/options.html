<html>
<head>
	<title>gleeBox Options</title>
	<style>
	body{
		background-color:#dedede;
		font-size:18px;
		line-height:30px;
		font-family:Garamond,Helvetica,serif;
	}
	h2{
		clear:both;
		margin-top:20px;
		font-size:35px;
		text-shadow: 1px 1px 2px #ccc;
		text-align: center;
	}
	h3{
		font-size:30px;
		text-shadow: 1px 1px 2px #ccc;
		margin:5px 0px;
		font-weight:normal;
		border-bottom: 1px solid #ccc;
	}

	ul.options {
		list-style-type:  none;
		margin: 0;
		margin-bottom:10px;
		margin-left:20px;
		margin-top:5px;
		padding: 0;
		width:100%;
		display:block;
		float:left;
		clear:both;
	}
	#options{
		float:left;
		margin-left:10px;
		padding-bottom:20px;
	}
	.option-label{
		float:left;
		width:200px;
	}
	.option-field{
		float:left;
		margin-left: 20px;
	}
	ul li{
		margin-bottom:30px;
		display:block;
		float:left;
		clear:both;
	}
	ul li li{
		border:none;
		float:none;
		margin:0;
		margin-bottom:5px;
	}
	ul li ul{
		margin:0;
		padding:0;
	}
	input{
		border:0;
		background-color:#ccc;
		border:1px solid #aaa;
		font-size:13px;
		border-radius:2px;
		padding:2px 3px;
		color:#333;
	}
	input:focus{
		outline:none;
	}
	.button:hover{
		cursor:pointer;
		background-color:#777;
		color:#fff;
	}
	.button:active{
		background-color:#444;
	}
	.inline_button{
		padding-left:20px;
		float:right;
	}
	#addDomainLi{
		margin-top:10px;
	}
	#status{
		padding:2px;
		text-align:center;
		margin:10px auto;
	}
	#wrap{
		margin:0 auto;
		width:700px;
	}
	.subtext{
		font-size:11px;
		font-family: "Lucida Grande", Lucida, Arial, sans-serif;
		line-height: 14px;
	}
	</style>
<script type="text/javascript">

// Saves options to localStorage
function save_options() {

	//saving the disabled URLs
	var restrictedDomains = [];
	var domainList = document.getElementById("domains");
	for(var i=0;i<domainList.children.length;i++)
	{
		if(domainList.children[i].className == "rdomain")
			restrictedDomains[restrictedDomains.length] = domainList.children[i].innerText;
	}
	//currently using , as the end marker. need a better way to implement this
	localStorage["glee_domains"] = restrictedDomains;

	//saving the gleeBox position
	if(document.getElementsByName("glee_pos")[0].checked) //top
		pos = 0;
	else if(document.getElementsByName("glee_pos")[1].checked) //middle
		pos = 1;
	else 	//bottom
		pos = 2;
	localStorage["glee_position"] = pos;
	
	//saving the gleeBox size
	if(document.getElementsByName("glee_size")[0].checked) //small
		size = 0;
	else if(document.getElementsByName("glee_size")[1].checked) //medium
		size = 1;
	else 	//large
		size = 2;
	localStorage["glee_size"] = size;
	
	//save theme
	tRadios = document.getElementsByName("glee_theme");
	for (var i=0; i < tRadios.length; i++)
	{
		if (tRadios[i].checked)
		{
			localStorage["glee_theme"] = tRadios[i].value;
			theme = tRadios[i].value;
			break;
		}
	}
	
	//save hyper
	if(document.getElementsByName("glee_hyper")[0].checked)
		hyper = localStorage["glee_hyper"] = 1; //1 indicates enabled
	else
		hyper = localStorage["glee_hyper"] = 0;

	//saving bookmarks search option
	if(document.getElementsByName("glee_bookmark_search")[0].checked)
		bookmark_search = 1; //1 indicates enabled
	else
		bookmark_search = 0;
	
	localStorage["glee_bookmark_search"] = bookmark_search;
	
	//saving scrolling animation pref
	if(document.getElementsByName("glee_scrolling_animation")[0].checked)
		animation = 1; //enabled
	else
		animation = 0;
	
	localStorage["glee_scrolling_animation"] = animation;

	var status = localStorage["glee_status"];
	if(typeof(status) == "undefined")
		status = 1;

	//saving the custom scraper commands
	var scraperName = [];
	var scraperSel = [];
	var scrapers = [];
	var scraperList = document.getElementById("scraper-commands");
	var len = scraperList.children.length;
	for(var i=0;i<len;i++)
	{
		var el = scraperList.children[i];
		if(el.className == "scraper")
		{
			var name = el.children[0].innerText;
			var sel = el.children[1].innerText;
			//get rid of the ? in command name
			name = name.slice(1,name.length);
			scrapers[i] = { command:name, selector:sel, cssStyle:"GleeReaped", nullMessage: "Could not find any elements"};
			//using ` as end marker for both scraper names and selectors
			scraperName[scraperName.length] = name+"`";
			scraperSel[scraperSel.length] = sel+"`";
		}
	}
	localStorage["glee_scraper_names"] = scraperName;
	localStorage["glee_scraper_selectors"] = scraperSel;
	propagateChanges(pos,size,bookmark_search,animation,restrictedDomains,status,theme,scrapers,hyper);
	setStatus("Settings saved!");
}

function propagateChanges(pos,size,bookmark_search,animation,domains,status,theme,scrapers,hyper){
	//get all the windows and their tabs to propagate the change in status
	chrome.windows.getAll({populate:true}, function(windows){
		for( i=0; i<windows.length; i++)
		{
			//set the status in all the tabs open in the window
			for(j=0;j<windows[i].tabs.length;j++)
			{
				chrome.tabs.sendRequest(windows[i].tabs[j].id, {value:"updateOptions",position:pos,size:size,bookmark_search:bookmark_search,animation:animation,domains:domains,status:status,theme:theme,scrapers:scrapers,hyper:hyper},function(response){
				});
			}
		}
	});
}
// Restores select box state to saved value from localStorage
function restore_options()
{
	initDefaultTexts();

	//getting the user defined restricted domains
	var domainBuffer = localStorage["glee_domains"];
	if(typeof(domainBuffer) == "undefined")
	{
		//initialize with the default domains that should be blocked
		domainBuffer = "mail.google.com,google.com/reader,wave.google.com";
		localStorage["glee_domains"] = domainBuffer;
	}
	if(domainBuffer.length != 0)
	{
		//parsing domainBuffer to get the domains
		var restrictedDomains = domainBuffer.split(",");
		var domainList = document.getElementById("domains");
		//TODO: use lastChild property here
		var lastChild = document.getElementById("addDomainLI");
		//displaying the domains in the restricted list
		for (var i=0; i<restrictedDomains.length; i++)
		{
			var newLI = document.createElement('li');
			var inputBt = "<input class='button' style='float:right' type='button' value='Remove' onclick='removeDomain("+i+")'/>";
			newLI.className = "rdomain";
			newLI.id = "rdomain"+i;
			newLI.innerHTML = restrictedDomains[i] + inputBt;
			domainList.insertBefore(newLI,lastChild);
		}
	}
	
	//getting the gleeBox position
	var pos = localStorage["glee_position"];
	if(pos)
		document.getElementsByName("glee_pos")[pos].checked = true;
	else
		document.getElementsByName("glee_pos")[1].checked = true; //default is middle position

	//getting the gleeBox size
	var size = localStorage["glee_size"];
	if(size)
		document.getElementsByName("glee_size")[size].checked = true;
	else
		document.getElementsByName("glee_size")[2].checked = true; //default is large size

	//getting theme
	var theme = localStorage["glee_theme"];
	tRadios = document.getElementsByName("glee_theme");
	if(theme)
	{
		for (var i=0; i < tRadios.length; i++)
		{
			if (theme == tRadios[i].value)
			{
				tRadios[i].checked = true;
				break;
			}
		}
	}
	else {
		tRadios[0].checked = true;
	}	
	// Getting HyperGlee
	var hyper = localStorage["glee_hyper"];
	hRadios = document.getElementsByName("glee_hyper");
	if(hyper != null)
	{
		if(hyper == 1)
			hRadios[0].checked = true;
		else
			hRadios[1].checked = true;
	}
	else
		hRadios[1].checked = true;

	//getting the bookmark search status (enabled/disabled)
	var bookmark_status = localStorage["glee_bookmark_search"];

	if(bookmark_status == 1)
		document.getElementsByName("glee_bookmark_search")[0].checked = true;
	else
		document.getElementsByName("glee_bookmark_search")[1].checked = true;

	//getting the scrolling animation pref
	var scroll_anim = localStorage["glee_scrolling_animation"];

	if(scroll_anim == 0)
		document.getElementsByName("glee_scrolling_animation")[1].checked = true;
	else
		document.getElementsByName("glee_scrolling_animation")[0].checked = true;

	//getting the custom scraper commands
	var scraper_names = localStorage["glee_scraper_names"];
	var scraper_sel = localStorage["glee_scraper_selectors"];
	if(scraper_names != "undefined")
	{
		if(scraper_names.length != 0)
		{
			var scraperList = document.getElementById("scraper-commands");
			var scraperName = scraper_names.split("`");
			var scraperSel = scraper_sel.split("`");
			var scraperLen = scraperName.length;
			//last element is a string only containing a ,
			for (var i=0; i<scraperLen-1; i++)
			{
				if(i>0)
				{
					//remove the , that is used by localStorage to separate elements
					scraperName[i] = scraperName[i].slice(1,scraperName[i].length);
					scraperSel[i] = scraperSel[i].slice(1,scraperSel[i].length);
				}
				var newLI = document.createElement('li');
				var inputBt = "<input class='button' style='float:right' type='button' value='Remove' onclick='removeScraper("+i+")'/>";
				newLI.className = "scraper";
				newLI.id = "scraper"+i;
				newLI.innerHTML = "<span><strong>?"+scraperName[i]+"</strong></span> : <span>"+scraperSel[i]+"</span>"+inputBt;
				scraperList.insertBefore(newLI,document.getElementById("addScraper"));
			}
		}
	}
}

//Adds a domain to the restricted domain list
function addDomain() {
	var newDomain = document.getElementById("add_domain");
	var lastChild = document.getElementById("addDomainLI");
	//TODO: create a validate() method with more strict validation
	if(newDomain.value != "")
	{
		var domainList = document.getElementById("domains");
		var newLI = document.createElement('li');
		var no = domainList.children.length+1;
		var inputBt = "<input class='button' style='float:right' type='button' value='Remove' onclick='removeDomain("+no+")'/>";
		newLI.className = "rdomain";
		newLI.id = "rdomain"+no;
		newLI.innerHTML = newDomain.value + inputBt;
		domainList.insertBefore(newLI,lastChild);
		newDomain.value = "";
		setStatus("URL Added!");
	}
}

function removeDomain(i){
	var el = document.getElementById("rdomain"+i);
	var domainList = document.getElementById("domains");
	domainList.removeChild(el);
	//remove the domain from the list
	setStatus("URL Removed!");
	return 0;
}

function addScraper(){
	var scraperName = document.getElementById("scraper-name");
	var scraperSel = document.getElementById("scraper-selector");

	if(validateScraper(scraperName.value,scraperSel.value))
	{
		var scraperList = document.getElementById("scraper-commands");
		var newLI = document.createElement("li");
		var no = scraperList.children.length+1;
		newLI.className = "scraper";
		newLI.id = "scraper"+no;
		var inputBt = "<input class='button' style='float:right' type='button' value='Remove' onclick='removeScraper("+no+")'/>";
		newLI.innerHTML = "<span><strong>?"+scraperName.value+"</strong></span> : <span>"+scraperSel.value+"</span>"+inputBt;
		scraperList.insertBefore(newLI,document.getElementById("addScraper"));
		setStatus("<strong>?"+scraperName.value+"</strong> command added!");
		scraperName.value="";
		scraperSel.value="";
	}
}

function removeScraper(i){
	var el = document.getElementById("scraper"+i);
	var scraperList = document.getElementById("scraper-commands");
	scraperList.removeChild(el);
	//remove the domain from the list
	setStatus("Command Removed!");
	return 0;
}

function validateScraper(name,selector)
{
	//check that command name/selector should not be blank
	if(name == "" || selector == "")
	{
		setStatus("Command name / Selector cannot be blank!");
		return false;
	}
	//check that command name does not conflict with the default scraper command names
	if(name == "h" || name == "?" || name == "img" || name == "p" || name == "a")
	{
		setStatus("Command name conflicts with a default scraper command!");
		return false;
	}
	return true;
}

function setStatus(text){
	document.getElementById("status").innerHTML = text;
}

function closeOptions(text){
	chrome.tabs.getSelected(null, function(tab){
		chrome.tabs.remove(tab.id, function(){});
	});
}

function clearDefaultText(e) {
    var target = window.event ? window.event.srcElement : e ? e.target : null;
    if (!target) return;
    
    if (target.value == target.defaultText) {
        target.value = '';
    }
}

function replaceDefaultText(e) {
    var target = window.event ? window.event.srcElement : e ? e.target : null;
    if (!target) return;
    
    if (target.value == '' && target.defaultText) {
        target.value = target.defaultText;
    }
}

function initDefaultTexts() {
    var formInputs = document.getElementsByTagName('input');
    for (var i = 0; i < formInputs.length; i++) {
        var theInput = formInputs[i];
        
        if (theInput.type == 'text') {  
            /* Add event handlers */          
            theInput.addEventListener('focus', clearDefaultText, false);
            theInput.addEventListener('blur', replaceDefaultText, false);
            /* Save the current value */
            if (theInput.value != '') {
                theInput.defaultText = theInput.value;
            }
        }
	}
}	

</script>
</head>
<body onload="restore_options()">
<div id="wrap">
<h2>gleeBox Options</h2>
<div id="status"></div>
<!--Specifying different options available -->
<div id="options">
	<h3>Features</h3>
	<ul class="options">
		<li>
			<label class="option-label">Disabled URLs:<br/><span class="subtext">Enter part of a URL to disable gleeBox on all pages with matching URLs</span></label>
			<ul id="domains" class="option-field">
				<li>chrome.google.com/extensions <span style="float:right;font-size:14px;color:gray">Disabled by Google</span></li>
				<li id="addDomainLI"><form onsubmit="addDomain();return false;"><input id="add_domain" type="text" value="" size=50 /><input type="submit" value="Add" class="button"/></form></li>
			</ul>
		</li>
		<li>
			<label class="option-label">Bookmark search:<br/><span class="subtext">Search bookmarks when no matching links are found on a page?</span></label>
			<div class="option-field">
				<input name="glee_bookmark_search" type="radio"> Enabled 
				<input name="glee_bookmark_search" type="radio"> Disabled
			</div>
		</li>
		<li>
			<label class="option-label">Animated scrolling:<br/><span class="subtext">Do scroll animation while traversing selected elements using gleeBox?</span></label>
			<div class="option-field">
				<input name="glee_scrolling_animation" type="radio"> Yes
				<input name="glee_scrolling_animation" type="radio"> No
			</div>
		</li>
		<!-- <li>
			<label class="option-label">HyperGlee<br/><span class="subtext">In the HyperGlee mode, gleeBox is visible by default when a page loads.</span></label>
			<div class="option-field">
				<input name="glee_hyper" value="enabled" type="radio"> Enabled
				<input name="glee_hyper" value="disabled" type="radio"> Disabled
			</div>
		</li> -->
		<li>
			<label class="option-label">Scraper commands:<br/><span class="subtext">Create your own custom scraper(?) commands by adding command name and a corresponding jQuery selector. <br/><br/><strong>* DO NOT</strong> use <strong>`</strong> in name or selector.</span></label>
			<ul id="scraper-commands" class="option-field">
				<li><strong>??</strong> : Input Elements<span style="float:right;font-size:14px;color:gray">In-built</span></li>
				<li><strong>?img</strong> : Linked Images<span style="float:right;font-size:14px;color:gray">In-built</span></li>
				<li><strong>?h</strong> : H1, H2 and H3 Elements<span style="float:right;font-size:14px;color:gray">In-built</span></li>
				<li><strong>?a</strong> : Links<span style="float:right;font-size:14px;color:gray">In-built</span></li>
				<li id="addScraper"><form onsubmit="addScraper();return false;">?<input id="scraper-name" type="text" value="Name" size=10 /> : <input id="scraper-selector" type="text" value="jQuery Selector" size=20 /><input type="submit" value="Add" class="button"/></form></li>
			</ul>
		</li>
	</ul>
	<h3>Appearance</h3>
	<ul class="options">
		<li>
			<label class="option-label">Position:</label>
			<div class="option-field">
				<input name="glee_pos" type="radio"> Top 
				<input name="glee_pos" type="radio"> Middle
				<input name="glee_pos" type="radio"> Bottom
			</div>
		</li>
		<li>
			<label class="option-label">Size:</label>
			<div class="option-field">
				<input name="glee_size" type="radio"> Small 
				<input name="glee_size" type="radio"> Medium 
				<input name="glee_size" type="radio"> Large
			</div>
		</li>
		<li>
			<label class="option-label">Theme:</label>
			<div class="option-field">
				<input name="glee_theme" value="GleeThemeDefault" type="radio"> Default <br>
				<input name="glee_theme" value="GleeThemeWhite"  type="radio"> White <br>
				<input name="glee_theme" value="GleeThemeConsole" type="radio"> Console <br>
				<input name="glee_theme" value="GleeThemeGreener" type="radio"> Greener <br>
				<input name="glee_theme" value="GleeThemeRuby" type="radio"> Ruby <br>
				<input name="glee_theme" value="GleeThemeGlee" type="radio"> New Directions
			</div>
		</li>
	</ul>
	<div style="text-align:center">
		<input type="button" class="button" value="Save" onclick="save_options()">
		<input type="button" class="button" value="Save and Close" onclick="save_options();closeOptions();">
	</div>
</div>
</div>	
</body>
</html>